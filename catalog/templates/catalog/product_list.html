{% extends 'base.html' %}
{% load static %}
{% block meta %}
    <title>hoophub - Catalog</title>
{% endblock meta %}

{% block content %}
{% include 'navbar.html' %}

<main>
<div class="max-w-7xl mx-auto px-6 py-8">
  <h1 class="text-4xl font-bold text-[#005C67] mb-6 text-center">
    Explore Our Basketball Collection
  </h1>
  <p class="text-center text-gray-600 mb-8">
    Find the best basketball product you ever have!
    <b>Nike</b>, <b>Adidas</b>, <b>Spalding</b>, <b>Wilson</b>, and <b>TARMAK</b>.
  </p>

  <!-- Header + Tombol -->
  <div class="flex justify-between items-center mb-6">
    <div class="flex items-center gap-3">
      <a href="{% url 'main:show_main' %}"
         class="inline-flex items-center gap-2 px-3 py-2 rounded-lg border border-gray-200 text-[#005C67] hover:bg-gray-50">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 3 2 12h3v8h6v-5h2v5h6v-8h3z" />
        </svg>
        Home
      </a>
      <h1 class="text-3xl font-bold text-[#005C67]">hoophub Catalog</h1>
    </div>

    {% if user.username == "Admin" or user.username == "admin" %}
      <button id="openAddModal"
              class="bg-[#EE9B00] text-white font-semibold px-4 py-2 rounded-lg hover:bg-[#d98f00] transition">
        + Add Product
      </button>
    {% endif %}
  </div>

  <!-- Product Grid -->
  <div id="productGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
  {% for p in products %}
    <div class="bg-white rounded-2xl shadow-md hover:shadow-lg transition p-4 flex flex-col">
      <a href="{% url 'catalog:product_detail' p.id %}">
        <img src="{{ p.image }}" alt="{{ p.name }}" class="h-56 w-full object-cover rounded-md mb-3">
        <h3 class="text-xl font-semibold text-[#005C67] hover:underline">{{ p.name }}</h3>
      </a>

      <p class="text-gray-600">{{ p.brand }} â€¢ {{ p.category }}</p>
      <p class="text-[#F5A623] font-bold mt-1 mb-2">Rp {{ p.price }}</p>

      <p class="text-sm {{ p.is_available|yesno:'text-green-600,text-red-600' }}">
        {% if p.is_available %}Available{% else %}Out of Product{% endif %}
      </p>
      <p class="text-xs text-gray-400 mb-4">Released: {{ p.release_date }}</p>

      {% if user.username == "Admin" or user.username == "admin" %}
        <div class="mt-auto flex justify-between">
          <button
            class="editBtn bg-[#005C67] text-white rounded-lg px-3 py-1 hover:bg-[#007681]"
            data-id="{{ p.id }}"
            data-name="{{ p.name|escape }}"
            data-brand="{{ p.brand|escape }}"
            data-category="{{ p.category }}"
            data-price="{{ p.price }}"
            data-stock="{{ p.stock }}"
            data-image="{{ p.image|escape }}"
            data-release_date="{{ p.release_date|date:'Y-m-d' }}"
            data-description="{{ p.description|escape }}"
            data-is_available="{{ p.is_available }}"
          > 
            Edit
          </button>

          <button
            class="deleteBtn bg-red-600 text-white rounded-lg px-3 py-1 hover:bg-red-700"
            data-id="{{ p.id }}">
            Delete
          </button>
        </div>
      
      {% else %}
        <div class="mt-auto">
          {% if p.is_available %}
            <form action="{% url 'cart:add_to_cart' p.id %}" method="POST" class="w-full">
              {% csrf_token %}
              <input type="hidden" name="quantity" value="1">
              
              <button type="submit" 
                      class="w-full bg-[#005C67] text-white rounded-lg px-3 py-2 hover:bg-[#007681] transition font-semibold">
                ðŸ›’ Add to Cart
              </button>
            </form>
          {% else %}
            <button type="button" disabled 
                    class="w-full bg-gray-400 text-white rounded-lg px-3 py-2 cursor-not-allowed font-semibold">
              Out of Stock
            </button>
          {% endif %}
        </div>
      {% endif %}
      </div>
  {% empty %}
    <p class="text-center text-gray-500 col-span-3">No products yet.</p>
  {% endfor %}
</div>

{% if user.username == "Admin" or user.username == "admin" %}
<!-- Modal Tambah / Edit Product (ADMIN ONLY) -->
<div id="productModal"
     class="fixed inset-0 bg-black bg-opacity-40 hidden flex justify-center items-center z-50 transition-all">
  <div id="modalCard"
       class="bg-white rounded-2xl shadow-2xl w-96 p-6 transform scale-95 opacity-0 transition-all duration-300">
    <h2 id="modalTitle" class="text-xl font-bold text-[#005C67] mb-4 text-center">Add Product</h2>

    <form id="productForm">
      {% csrf_token %}
      <input type="hidden" name="id" id="productId">

      <div class="space-y-3">
        <input type="text" name="name" id="name" placeholder="Name of Product" class="w-full border rounded p-2" required>
        <input type="text" name="brand" id="brand" placeholder="Brand" class="w-full border rounded p-2" required>
        <textarea name="description" id="description" placeholder="Product Description"
                  class="w-full border rounded p-2 h-24 resize-none"></textarea>
        <label class="flex items-center gap-2 text-gray-700">
          <input type="checkbox" name="is_available" id="is_available" class="w-4 h-4 border-gray-300 rounded" />
          <span>Available</span>
        </label>

        <select name="category" id="category" class="w-full border rounded p-2" required>
          <option value="">Category</option>
          <option value="Shoes">Shoes</option>
          <option value="Jersey">Jersey</option>
          <option value="Ball">Ball</option>
          <option value="Pants">Pants</option>
          <option value="Accessories">Accessories</option>
        </select>

        <input type="number" name="price" id="price" placeholder="Price (Rp)" class="w-full border rounded p-2" required>
        <input type="number" name="stock" id="stock" placeholder="Stock" class="w-full border rounded p-2" required>
        <input type="url" name="image" id="image" placeholder="Link Image (URL)" class="w-full border rounded p-2">
        <input type="date" name="release_date" id="release_date" class="w-full border rounded p-2">
      </div>

      <div class="flex justify-end gap-2 mt-5">
        <button type="button" id="closeModal" class="text-gray-500 hover:text-gray-700">No</button>
        <button type="submit" id="saveBtn" class="bg-[#005C67] text-white px-4 py-2 rounded hover:bg-[#007681] transition">
          Save
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Modal Konfirmasi Delete (ADMIN ONLY) -->
<div id="deleteModal"
     class="fixed inset-0 bg-black bg-opacity-40 hidden flex justify-center items-center z-50 transition-all">
  <div id="deleteCard"
       class="bg-white rounded-2xl shadow-2xl w-80 p-6 text-center transform scale-95 opacity-0 transition-all duration-300">
    <h3 class="text-lg font-semibold text-gray-800 mb-3">
      Are you sure you want to delete this product?
    </h3>
    <p class="text-gray-500 mb-5">This action cannot be undone.</p>
    <div class="flex justify-center gap-3">
      <button id="cancelDelete" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">No</button>
      <button id="confirmDelete" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Delete</button>
    </div>
  </div>
</div>


<script>
document.addEventListener("DOMContentLoaded", () => {
  // --- Helpers ---
  const getCookie = (name) => {
    const v = `; ${document.cookie}`;
    const p = v.split(`; ${name}=`);
    if (p.length === 2) return p.pop().split(';').shift();
  };
  const csrftoken = getCookie('csrftoken');

  const productModal = document.getElementById("productModal");
  const deleteModal = document.getElementById("deleteModal");
  const modalCard = document.getElementById("modalCard");
  const deleteCard = document.getElementById("deleteCard");
  const openAddModal = document.getElementById("openAddModal");
  const closeModal = document.getElementById("closeModal");
  const productForm = document.getElementById("productForm");
  const modalTitle = document.getElementById("modalTitle");
  const confirmDelete = document.getElementById("confirmDelete");
  const cancelDelete = document.getElementById("cancelDelete");
  let deleteId = null;

  // Animasi modal
  const showModal = (modal, card) => {
    modal.classList.remove("hidden");
    setTimeout(() => card.classList.replace("scale-95", "scale-100"), 20);
    card.classList.replace("opacity-0", "opacity-100");
  };
  const hideModal = (modal, card) => {
    card.classList.replace("scale-100", "scale-95");
    card.classList.replace("opacity-100", "opacity-0");
    setTimeout(() => modal.classList.add("hidden"), 200);
  };

  // Add Product
  if (openAddModal) {
    openAddModal.addEventListener("click", () => {
      modalTitle.textContent = "Add Product";
      productForm.reset();
      document.getElementById("productId").value = "";
      showModal(productModal, modalCard);
    });
  }

  if (closeModal)
    closeModal.addEventListener("click", () => hideModal(productModal, modalCard));

  // Edit Product
  document.querySelectorAll(".editBtn").forEach(btn => {
    btn.addEventListener("click", () => {
      modalTitle.textContent = "Edit Product";
      document.getElementById("productId").value = btn.dataset.id || "";
      document.getElementById("name").value = btn.dataset.name || "";
      document.getElementById("brand").value = btn.dataset.brand || "";
      document.getElementById("category").value = btn.dataset.category || "";
      document.getElementById("price").value = btn.dataset.price || "";
      document.getElementById("stock").value = btn.dataset.stock || "";
      document.getElementById("image").value = btn.dataset.image || "";
      document.getElementById("release_date").value = btn.dataset.release_date || "";
      showModal(productModal, modalCard);
    });
  });

  // Delete Product
  document.querySelectorAll(".deleteBtn").forEach(btn => {
    btn.addEventListener("click", () => {
      deleteId = btn.dataset.id;
      showModal(deleteModal, deleteCard);
    });
  });

  if (cancelDelete)
    cancelDelete.addEventListener("click", () => hideModal(deleteModal, deleteCard));

  if (confirmDelete) {
    confirmDelete.addEventListener("click", async () => {
      if (!deleteId) return;
      const res = await fetch(`/catalog/delete/${deleteId}/`, {
        method: "POST",
        headers: { "X-CSRFToken": csrftoken },
      });
      if (res.ok) {
        hideModal(deleteModal, deleteCard);
        const card = document.querySelector(`.deleteBtn[data-id='${deleteId}']`)?.closest(".bg-white");
        if (card) card.remove();
      } else {
        alert("Delete product failed.");
      }
    });
  }

  // Submit Add/Edit
  if (productForm) {
    productForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const formData = new FormData(productForm);
      const id = formData.get("id");
      const url = id ? `/catalog/update/${id}/` : "{% url 'catalog:product_create' %}";

      const res = await fetch(url, {
        method: "POST",
        headers: { "X-CSRFToken": csrftoken },
        body: formData,
      });

      if (res.ok) {
        hideModal(productModal, modalCard);
        location.reload();
      } else {
        alert("Error. Try again later.");
      }
    });
  }
});
</script>

{% endif %}
</main>
{% endblock %}