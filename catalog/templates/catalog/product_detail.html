{% extends 'base.html' %}
{% load static %}

{% block meta %}
<style>
  .review-container {
        display: flex;
        flex-direction: column;
        gap: 20px;
        padding: 20px;
    }
    .review-card {
        display: flex;
        align-items: flex-start;
        gap: 20px;
        padding: 0 clamp(20px, 7vw, 60px) 10px;
        justify-content: flex-end;
        align-items: flex-start;
    }
    .review-details {
        display: flex;
        flex-direction: column;
        flex-grow: 1;
    }
    .review-date {
        font-size: 0.8em;
        font-style: italic;
    }
    .review-product-image {
        width: 120px;
        height: 120px;
        object-fit: contain;
        flex-shrink: 0;
    }
    .review-product-content {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    .review-product-name {
        color: #000;
        font-size: 1.1em;
        font-weight: 600;
        color: #000;
    }
    .review-product-price {
        color: #000;
        font-size: 1em;
        font-weight: 500;
        color: #000;
    }
    .review-message {
        color: #343A40;
        font-size: 1em;
        font-weight: 400;
        overflow-wrap: break-word;
    }
    .rating {
        display: flex;
    }
    .rating .star {
        font-size: 1.5em;
        color: #D9D9D9;
    }
    .rating .star.rated {
        font-size: 1.5em;
        color: #EE9B00;
    }
</style>
{% endblock meta %}

{% block content %}
{% include 'navbar.html' %}

<div class="max-w-7xl mx-auto px-6 py-8">
  <!-- Back -->
  <a href="{% url 'catalog:product_list' %}" class="inline-flex items-center gap-2 text-[#005C67] hover:underline mb-6">
    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
      <path d="M15 19l-7-7 7-7"/>
    </svg>
    Back to Catalog
  </a>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
    <!-- Image -->
    <div class="bg-gray-50 rounded-2xl p-4">
      {% if p.image %}
        <img src="{{ p.image }}" alt="{{ p.name }}" class="w-full rounded-xl object-cover" />
      {% else %}
        <div class="w-full h-80 bg-gray-200 rounded-xl"></div>
      {% endif %}
    </div>

    <!-- Info -->
    <div>
      <h1 class="text-4xl font-extrabold text-[#0f5257] leading-tight mb-2">
        {{ p.name }}
      </h1>

      <p class="text-gray-600 mb-2">{{ p.brand }} â€¢ {{ p.category }}</p>

      <p class="text-[#F5A623] text-2xl font-bold mb-3">Rp {{ p.price }}</p>

      <div class="flex items-center gap-4 mb-6">
        <span class="px-3 py-1 rounded-full text-sm font-medium
          {% if p.is_available %} bg-green-100 text-green-700 {% else %} bg-red-100 text-red-700 {% endif %}">
          {% if p.is_available %}Available{% else %}Out of Stock{% endif %}
        </span>
        {% if p.release_date %}
          <span class="text-sm text-gray-500">Release date: {{ p.release_date }}</span>
        {% endif %}
      </div>

      <!-- hanya user yang sudah login yang bisa lihat button review, dan admin/user belum login tidak bisa lihat buttonnya -->
      {% if user.is_authenticated and 'admin' not in request.user.username.lower %}
        <div>
          <button type="button" class="mb-6 px-4 py-2 bg-[#EE9B00] text-white font-semibold rounded-lg hover:bg-[#CA6702] transition" onclick="showCreateReviewModal({{ p.id }})">
              Review
          </button>
        </div>
      {% endif %}

      <h2 class="text-xl font-semibold text-[#0f5257] mb-3">Description</h2>
      <div class="prose max-w-none text-gray-700 leading-relaxed">
        {{ p.description|linebreaksbr|default:"No description." }}
      </div>

      <h2 class="text-xl font-semibold text-[#0f5257] mb-3 mt-6">Reviews</h2>
      <div id="review-container" class="flex flex-col gap-5"></div>
    </div>
  </div>
</div>

<script>
  function stars(rating) {
      let stars = '';
      for (let i = 1; i <= 5; i++) { // kalau ada rating, kasih class 'rated' (untuk kasih style)
          stars += `<span class="star ${i <= rating ? 'rated' : ''}">&#9733;</span>`;
      }
      return stars;
  }

  async function loadProductReview() {
    const productId = {{ p.pk }};
    const reviewContainer = document.getElementById('review-container');

    reviewContainer.innerHTML = '';

    const response = await fetch(`/catalog/review/${productId}`);
    const reviews = await response.json();

    if (reviews.length === 0) {
      reviewContainer.innerHTML = `<h2>No reviews yet.</h2>`;
      return;
    }

    reviews.forEach(review => { reviewContent = `
        <div class="flex flex-col md:flex-row items-start justify-start">
          <div class="review-details">
              <p class="font-semibold text-[0.8em]">${review.user}</p>
              <p class="review-date">${review.date}</p>
              <div class="rating">
                  ${stars(review.rating)}
              </div>
              <h3 class="review-message">${review.review}</h3>
          </div>
        </div>
      `;
        reviewContainer.innerHTML += reviewContent;
    });
  }

  document.addEventListener('DOMContentLoaded', function() {
    loadProductReview();
  });
</script>
{% endblock %}