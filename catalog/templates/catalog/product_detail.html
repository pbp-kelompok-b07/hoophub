{% extends 'base.html' %}
{% load static %}

{% block meta %}
    <title>hoophub - Product Details</title>
<style>
  .review-container {
        display: flex;
        flex-direction: column;
        gap: 20px;
        padding: 20px;
    }
    .review-card {
        display: flex;
        align-items: flex-start;
        gap: 20px;
        padding: 0 clamp(20px, 7vw, 60px) 10px;
        justify-content: flex-end;
        align-items: flex-start;
    }
    .review-details {
        display: flex;
        flex-direction: column;
        flex-grow: 1;
    }
    .review-date {
        font-size: 0.8em;
        font-style: italic;
    }
    .review-product-image {
        width: 120px;
        height: 120px;
        object-fit: contain;
        flex-shrink: 0;
    }
    .review-product-content {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    .review-product-name {
        color: #000;
        font-size: 1.1em;
        font-weight: 600;
        color: #000;
    }
    .review-product-price {
        color: #000;
        font-size: 1em;
        font-weight: 500;
        color: #000;
    }
    .review-message {
        color: #343A40;
        font-size: 1em;
        font-weight: 400;
        overflow-wrap: break-word;
    }
    .rating {
        display: flex;
    }
    .rating .star {
        font-size: 1.5em;
        color: #D9D9D9;
    }
    .rating .star.rated {
        font-size: 1.5em;
        color: #EE9B00;
    }

    /* wishlist button specific */
    .wishlist-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      font-weight: 600;
      border-radius: 10px;
      cursor: pointer;
      transition: background-color .15s ease, transform .06s ease;
      border: none;
      outline: none;
      text-decoration: none;
    }
    .wishlist-btn:active { transform: translateY(1px); }
    .wishlist-btn .heart {
      width: 18px;
      height: 18px;
      display: inline-block;
      line-height: 0;
      vertical-align: middle;
      font-size: 0;
    }
    .wishlist-btn.added {
      background-color: #ffd8a8; /* soft highlight when added */
      color: #9b4d00;
    }
    /* keep Review button style consistent */
    .review-action-group {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-bottom: 1.25rem;
    }
</style>
{% endblock meta %}

{% block content %}
{% include 'navbar.html' %}

<main>
<div class="max-w-7xl mx-auto px-6 py-8">
  <!-- Back -->
  <a href="{% url 'catalog:product_list' %}" class="inline-flex items-center gap-2 text-[#005C67] hover:underline mb-6">
    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
      <path d="M15 19l-7-7 7-7"/>
    </svg>
    Back to Catalog
  </a>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
    <!-- Image -->
    <div class="bg-gray-50 rounded-2xl p-4">
      {% if p.image %}
        <img src="{{ p.image }}" alt="{{ p.name }}" class="w-full rounded-xl object-cover" />
      {% else %}
        <div class="w-full h-80 bg-gray-200 rounded-xl"></div>
      {% endif %}
    </div>

    <!-- Info -->
    <div>
      <h1 class="text-4xl font-extrabold text-[#0f5257] leading-tight mb-2">
        {{ p.name }}
      </h1>

      <p class="text-gray-600 mb-2">{{ p.brand }} â€¢ {{ p.category }}</p>

      <p class="text-[#F5A623] text-2xl font-bold mb-3">Rp {{ p.price }}</p>

      <div class="flex items-center gap-4 mb-6">
        <span class="px-3 py-1 rounded-full text-sm font-medium
          {% if p.is_available %} bg-green-100 text-green-700 {% else %} bg-red-100 text-red-700 {% endif %}">
          {% if p.is_available %}Available{% else %}Out of Stock{% endif %}
        </span>
        {% if p.release_date %}
          <span class="text-sm text-gray-500">Release date: {{ p.release_date }}</span>
        {% endif %}
      </div>

      <!-- hanya user yang sudah login yang bisa lihat button review, dan admin/user belum login tidak bisa lihat buttonnya -->
      {% if user.is_authenticated and request.user.username.lower != 'admin' %}
        <div>
          <div class="review-action-group">
            <button type="button" class="mb-6 px-4 py-2 bg-[#EE9B00] text-white font-semibold rounded-lg hover:bg-[#CA6702] transition" onclick="showCreateReviewModal({{ p.id }})" id="review-btn-{{ p.id }}">
                Review
            </button>

            <!-- ADD TO WISHLIST BUTTON (di sebelah tombol Review) -->
            <button id="wishlist-btn-{{ p.id }}" data-product-id="{{ p.id }}" class="wishlist-btn mb-6 bg-white border border-[#EEE] text-[#0f5257]" onclick="handleWishlistClick(event, {{ p.id }})" aria-pressed="false" title="Add to wishlist">
              <!-- heart icon (outline by default) -->
              <span class="heart" aria-hidden="true" id="wishlist-heart-{{ p.id }}">
                <!-- outline heart SVG -->
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M20.8 6.6c-1.8-2-4.9-2-6.8-.2L12 8l-1.9-1.6c-1.9-1.8-5-1.8-6.8.2-2 2.1-2 5.5 0 7.6L12 21l8.8-6.8c2-2.1 2-5.5 0-7.6z"/>
                </svg>
              </span>
              <span id="wishlist-text-{{ p.id }}">Add to wishlist</span>
            </button>
          </div>
        </div>
      {% endif %}

      <h2 class="text-xl font-semibold text-[#0f5257] mb-3">Description</h2>
      <div class="prose max-w-none text-gray-700 leading-relaxed">
        {{ p.description|linebreaksbr|default:"No description." }}
      </div>

      <h2 class="text-xl font-semibold text-[#0f5257] mb-3 mt-6">Reviews</h2>
      <div id="review-container" class="flex flex-col gap-5"></div>

      <div class="flex items-center justify-between border-t pt-4 mt-14">
        <p class="text-gray-600 text-xs">Something wrong with this product?</p>
        <button 
          type="button" 
          class="flex items-center text-[#E68A00] font-semibold hover:underline text-sm"
          onclick="showReportModal({{ p.id }})">
          <svg xmlns="http://www.w3.org/2000/svg" 
              viewBox="0 0 24 24" 
              fill="none" 
              stroke="currentColor" 
              stroke-width="1.5" 
              class="w-5 h-5 mr-1 flex-shrink-0">
            <path stroke-linecap="round" stroke-linejoin="round" 
                  d="M12 9v4m0 4h.01M10.29 3.86a1 1 0 011.42 0l8.48 13.7A1 1 0 0119.48 19H4.52a1 1 0 01-.71-1.44l8.48-13.7z" />
          </svg>
          Report
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  function stars(rating) {
      let stars = '';
      for (let i = 1; i <= 5; i++) {
          stars += `<span class="star ${i <= rating ? 'rated' : ''}">&#9733;</span>`;
      }
      return stars;
  }

  async function loadProductReview() {
    const productId = {{ p.pk }};
    const reviewContainer = document.getElementById('review-container');

    reviewContainer.innerHTML = '';

    const response = await fetch(`/catalog/review/${productId}`);
    const reviews = await response.json();

    if (reviews.length === 0) {
      reviewContainer.innerHTML = `<h2>No reviews yet.</h2>`;
      return;
    }

    reviews.forEach(review => { reviewContent = `
        <div class="flex flex-col md:flex-row items-start justify-start">
          <div class="review-details">
              <p class="font-semibold text-[0.8em]">${review.user}</p>
              <p class="review-date">${review.date}</p>
              <div class="rating">
                  ${stars(review.rating)}
              </div>
              <h3 class="review-message">${review.review}</h3>
          </div>
        </div>
      `;
        reviewContainer.innerHTML += reviewContent;
    });
  }

  // --- CSRF helper (standard Django cookie approach) ---
  function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
              const cookie = cookies[i].trim();
              if (cookie.substring(0, name.length + 1) === (name + '=')) {
                  cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                  break;
              }
          }
      }
      return cookieValue;
  }

  // --- wishlist endpoints (template tags) ---
  const WISHLIST_LIST_URL = "{% url 'wishlist:list' %}";
  const WISHLIST_TOGGLE_URL = "{% url 'wishlist:toggle_wishlist' p.id %}";

  // --- set button visual to "added" state ---
  function setWishlistButtonAdded(productId) {
    const btn = document.getElementById(`wishlist-btn-${productId}`);
    const heart = document.getElementById(`wishlist-heart-${productId}`);
    const textEl = document.getElementById(`wishlist-text-${productId}`);
    if (!btn || !heart || !textEl) return;
    btn.classList.add('added');
    btn.setAttribute('aria-pressed', 'true');
    textEl.textContent = 'Added to wishlist';
    heart.innerHTML = `
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="#EE9B00" stroke="none">
        <path d="M12 21s-7.043-4.682-9.4-7.03C-0.05 11.31.9 7.5 4.1 6c1.7-.8 3.6-.6 4.9.6L12 9.3l2.99-2.7c1.3-1.2 3.2-1.4 4.9-.6 3.2 1.5 4.1 5.31 1.5 7.97C19.043 16.318 12 21 12 21z"/>
      </svg>`;
  }
  function setWishlistButtonRemoved(productId) {
    const btn = document.getElementById(`wishlist-btn-${productId}`);
    const heart = document.getElementById(`wishlist-heart-${productId}`);
    const textEl = document.getElementById(`wishlist-text-${productId}`);
    if (!btn || !heart || !textEl) return;
    btn.classList.remove('added');
    btn.setAttribute('aria-pressed', 'false');
    textEl.textContent = 'Add to wishlist';
    heart.innerHTML = `
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <path d="M20.8 6.6c-1.8-2-4.9-2-6.8-.2L12 8l-1.9-1.6c-1.9-1.8-5-1.8-6.8.2-2 2.1-2 5.5 0 7.6L12 21l8.8-6.8c2-2.1 2-5.5 0-7.6z"/>
      </svg>`;
  }

  // --- check on load if this product already in wishlist ---
  async function checkIfInWishlistOnLoad(productId) {
    try {
      const res = await fetch(WISHLIST_LIST_URL, { credentials: 'same-origin' });
      if (!res.ok) return;
      const text = await res.text();
      // The wishlist page renders .wish-card with data-product-id="{{ product.pk }}"
      const needle = `data-product-id="${productId}"`;
      if (text.indexOf(needle) !== -1) {
        setWishlistButtonAdded(productId);
      } else {
        setWishlistButtonRemoved(productId);
      }
    } catch (e) {
      // ignore network errors silently
      console.error('checkIfInWishlistOnLoad error', e);
    }
  }

  // --- Broadcast + LocalStorage notifier so wishlist page can refresh itself (if open) ---
  function notifyWishlistChanged(productId, added) {
    try {
      // BroadcastChannel (modern browsers)
      if (window.BroadcastChannel) {
        const bc = new BroadcastChannel('wishlist_channel');
        bc.postMessage({ productId, added, ts: Date.now() });
        bc.close();
      }
    } catch (e) {
      console.error(e);
    }

    try {
      // localStorage event (triggers storage event in other tabs)
      localStorage.setItem('wishlist_changed', JSON.stringify({ productId, added, ts: Date.now() }));
    } catch (e) {
      // ignore
    }
  }

  // --- Wishlist toggle handler ---
  async function handleWishlistClick(event, productId) {
    event.preventDefault();
    const btn = document.getElementById(`wishlist-btn-${productId}`);
    const textEl = document.getElementById(`wishlist-text-${productId}`);
    if (!btn) return;

    const csrftoken = getCookie('csrftoken');

    // optimistic UI disable
    btn.disabled = true;
    btn.style.opacity = 0.85;

    try {
      const res = await fetch(WISHLIST_TOGGLE_URL, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrftoken,
          'Accept': 'application/json',
        },
        credentials: 'same-origin',
      });

      if (!res.ok) {
        console.error('Wishlist toggle failed', res.status);
        textEl.textContent = 'Action failed';
        setTimeout(() => {
          const state = btn.classList.contains('added') ? 'Added to wishlist' : 'Add to wishlist';
          textEl.textContent = state;
        }, 1200);
      } else {
        let data = {};
        try { data = await res.json(); } catch (e) { /* no JSON body */ }

        // prefer explicit `added` boolean from backend
        let added = null;
        if (typeof data.added !== 'undefined') {
          added = !!data.added;
        } else if (typeof data.removed !== 'undefined') {
          added = !data.removed;
        } else {
          // fallback: toggle current class
          added = !btn.classList.contains('added');
        }

        if (added) {
          setWishlistButtonAdded(productId);
        } else {
          setWishlistButtonRemoved(productId);
        }

        // notify other tabs/pages
        notifyWishlistChanged(productId, added);
      }
    } catch (err) {
      console.error('Error toggling wishlist:', err);
      textEl.textContent = 'Network error';
      setTimeout(() => {
        const state = btn.classList.contains('added') ? 'Added to wishlist' : 'Add to wishlist';
        textEl.textContent = state;
      }, 1200);
    } finally {
      btn.disabled = false;
      btn.style.opacity = 1;
    }
  }

  document.addEventListener('DOMContentLoaded', function() {
    loadProductReview();

    // only attempt wishlist check if wishlist button exists (user authenticated)
    const productId = {{ p.pk }};
    const wishlistBtn = document.getElementById(`wishlist-btn-${productId}`);
    if (wishlistBtn) {
      checkIfInWishlistOnLoad(productId);
    }
  });
</script>
{% endblock %}