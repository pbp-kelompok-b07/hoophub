{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="max-w-7xl mx-auto px-6 py-8">
  <h1 class="text-4xl font-bold text-[#005C67] mb-6 text-center">HoopHub Catalog</h1>
  <p class="text-center text-gray-600 mb-8">
    Jelajahi produk-produk terbaik dari <b>Nike</b>, <b>Adidas</b>, <b>Spalding</b>, <b>Wilson</b>, dan <b>TARMAK</b>.
  </p>

  <!-- Filter Form -->
  <form id="filter-form" class="flex flex-wrap justify-center gap-3 mb-10">
    <input type="text" name="q" placeholder="Cari produk..." class="border rounded-lg p-2 w-48">
    <select name="category" class="border rounded-lg p-2">
      <option value="">Semua Kategori</option>
      <option value="Shoes">Sepatu</option>
      <option value="Jersey">Jersey</option>
      <option value="Ball">Bola</option>
      <option value="Hoop">Ring</option>
      <option value="Accessories">Aksesoris</option>
    </select>
    <input type="text" name="brand" placeholder="Merek" class="border rounded-lg p-2 w-40">
    <button type="submit" class="bg-[#005C67] text-white rounded-lg px-4 py-2 hover:bg-[#007681]">
      Cari
    </button>
  </form>

  <!-- Product Grid -->
  <div id="product-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8 text-center">
    <p class="text-gray-400">Memuat produk...</p>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const container = document.getElementById("product-container");
  const form = document.getElementById("filter-form");

  function formatRupiah(angka) {
    let numberString = angka.toString().replace(/[^,\d]/g, ""),
        split = numberString.split(","),
        sisa = split[0].length % 3,
        rupiah = split[0].substr(0, sisa),
        ribuan = split[0].substr(sisa).match(/\d{3}/gi);
    if (ribuan) {
      let separator = sisa ? "." : "";
      rupiah += separator + ribuan.join(".");
    }
    rupiah = split[1] !== undefined ? rupiah + "," + split[1] : rupiah;
    return "Rp " + rupiah;
  }

  function loadProducts(params = "") {
    fetch(`{% url 'catalog:products_json' %}?${params}`)
      .then((res) => res.json())
      .then((products) => {
        container.innerHTML = "";
        if (products.length === 0) {
          container.innerHTML = `<p class="text-center text-gray-500 col-span-3">Tidak ada produk ditemukan.</p>`;
          return;
        }

        products.forEach((p) => {
          const price = formatRupiah(p.price);
          const rating = p.rating ? `⭐ ${p.rating.toFixed(1)}/5` : "";
          const releaseDate = p.release_date
            ? new Date(p.release_date).toLocaleDateString("id-ID", {
                year: "numeric",
                month: "short",
                day: "numeric",
              })
            : "-";
          const available = p.is_available
            ? `<p class='text-green-600 font-medium'>Tersedia</p>`
            : `<p class='text-red-600 font-medium'>Stok Habis</p>`;

          container.innerHTML += `
          <div class="bg-white rounded-xl shadow-md hover:shadow-lg transition p-4 flex flex-col">
            ${p.image ? `<img src="${p.image}" alt="${p.name}" class="h-56 w-full object-cover rounded-md mb-3">`
                       : `<div class="h-56 w-full bg-gray-100 rounded-md mb-3"></div>`}
            <h3 class="text-xl font-semibold text-[#005C67]">${p.name}</h3>
            <p class="text-gray-600">${p.brand} • ${p.category}</p>
            <p class="text-[#F5A623] font-bold mt-1 mb-2">${price}</p>
            <p class="text-sm text-gray-700 mb-1">${rating}</p>
            <p class="text-xs text-gray-400 mb-2">Dirilis: ${releaseDate}</p>
            ${available}
          </div>`;
        });
      })
      .catch((err) => {
        container.innerHTML = `<p class="text-red-500 text-center">Gagal memuat produk.</p>`;
        console.error(err);
      });
  }

  // saat halaman dibuka
  loadProducts();

  // saat filter di-submit
  form.addEventListener("submit", function (e) {
    e.preventDefault();
    const params = new URLSearchParams(new FormData(form)).toString();
    loadProducts(params);
  });
});
</script>
{% endblock %}
