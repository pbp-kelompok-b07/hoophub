{% extends "base.html" %}
{% load static %}

{% block content %}
{% include "navbar.html" %}

<style>
.wl-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 6px 10px; 
  width: 110px;
  height: 40px;
  border-radius: 1000px;
  box-shadow: 0 4px 4px rgba(0,0,0,0.25);
  font-family: Poppins, sans-serif;
  font-weight: 600;
  font-size: 13px;
  line-height: 1;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  text-align: center;
}

.btn-add-cart { background: #EE9B00; color: #fff; }
.btn-remove-wl { background: #BB3E03; color: #fff; }

/* label di dalam tombol, aman untuk truncation */
.wl-btn .btn-label {
  display: inline-block;
  max-width: 100%;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  vertical-align: middle;
}

/* Override inline border-bottom pada container header (tidak merubah HTML) */
div[style*="border-bottom:2px dashed #005F73"] {
  /* hapus border inline yang ada */
  border-bottom: none !important;
  position: relative;
  padding-bottom: 14px !important;
}

/* pseudo-element: garis pendek, dashed, terpusat */
div[style*="border-bottom:2px dashed #005F73"]::after {
  content: "";
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
  bottom: 6px;
  width: 1220px;
  border-bottom: 2px dashed #005F73;
  pointer-events: none;
  box-sizing: border-box;
}
</style>

<div class="max-w-full flex justify-center">
  <div class="w-full max-w-[1518px]">
    {% if not request.user.is_authenticated %}
      <!-- User belum login -->
      <div class="flex flex-col items-center justify-center p-10 text-center">
        <p class="text-xl font-semibold mb-4">Sign in to view your wishlist!</p>
        <a href="{% url 'authentication:login' %}" 
           class="px-6 py-3 rounded-full bg-[#005F73] text-white font-semibold hover:bg-[#007f92]">
          Sign In
        </a>
      </div>
    {% else %}
    <!-- Header -->
      <div class="flex items-center gap-2 px-5 py-2"
           style="border-bottom:2px dashed #005F73; padding:10px 20px;">
        <h2 style="color:#000; font-family:Poppins, sans-serif; font-size:24px; font-weight:600; line-height:normal;">
          Your wishlist is here!
        </h2>
      </div>
    {% endif %}

    <!-- Messages -->
    <div id="wl-messages" class="px-5 py-3"></div>

    <!-- GRID WRAPPER (HIGHLIGHT) -->
    <div id="wish-grid" class="grid grid-cols-1 md:grid-cols-2 gap-y-8 gap-x-12 px-8 py-6">
      {% if wish_items %}
        {% for item in wish_items %}
          {% with product=item.product %}

          <!-- CARD (keperluan desain: ukuran tetap untuk desktop; responsive di mobile) -->
          <div class="wish-card rounded-2xl overflow-hidden bg-[#005F73] p-6 flex flex-col md:flex-row items-center gap-6"
               data-wishlist-id="{{ item.pk }}" data-product-id="{{ product.pk }}">
            <!-- Image box -->
            <a href="{% if product.get_absolute_url %}{{ product.get_absolute_url }}{% else %}{% url 'catalog:product_detail' product.pk %}{% endif %}"
               class="block flex-shrink-0">
              {% if product.image %}
                <div class="w-56 h-56 rounded-xl bg-center bg-contain bg-no-repeat"
                     style="background-image: url('{{ product.image }}'); background-color: lightgray;">
                </div>
              {% else %}
                <div class="w-56 h-56 bg-gray-300 rounded-xl flex items-center justify-center">
                  <span class="text-gray-500">No Image</span>
                </div>
              {% endif %}
            </a>

            <!-- Title & buttons -->
            <div class="flex-1 flex flex-col items-center text-white"
                 style="min-width:0; height:150px; justify-content:space-between;">

              <!-- Title -->
              <a href="{% if product.get_absolute_url %}{{ product.get_absolute_url }}{% else %}{% url 'catalog:product_detail' product.pk %}{% endif %}">
                <p style="
                  color:#FFF;
                  font-family:Poppins, sans-serif;
                  font-size:16px;
                  font-style:normal;
                  font-weight:500;
                  line-height:normal;
                  width:236px;
                  text-align:center;
                  overflow:hidden;
                  text-overflow:ellipsis;
                  white-space:nowrap;
                  ">
                  {{ product.name }}
                </p>
              </a>

              <!-- Buttons di bawah -->
              <div class="mt-auto flex justify-center gap-4 w-full">
                <!-- Add to cart -->
                <button
                  class="wl-btn btn-add-cart"
                  data-product-id="{{ product.pk }}"
                  data-url="{% url 'cart:add_to_cart' product.pk %}"
                  aria-label="Add {{ product.name }} to cart"
                >
                  <span class="btn-label">Add to cart</span>
                </button>

                <!-- Delete -->
                <button
                  class="wl-btn btn-remove-wl"
                  data-wishlist-id="{{ item.pk }}"
                  data-url="{% url 'wishlist:remove_from_wishlist' item.pk %}"
                  aria-label="Delete {{ product.name }} from wishlist"
                >
                  <span class="btn-label">Delete</span>
                </button>
              </div>
            </div>
          </div>

          {% endwith %}
        {% endfor %}
      {% else %}
        <div class="col-span-2 p-6">
          <p class="text-gray-600">Your wishlist is empty.</p>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- SCRIPT: AJAX handlers (HIGHLIGHT: menggunakan data-url, bukan replace trick) -->
<script>
/* CSRF helper (sama seperti sebelumnya) */
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== "") {
    const cookies = document.cookie.split(';');
    for (let c of cookies) {
      c = c.trim();
      if (c.startsWith(name + '=')) {
        cookieValue = decodeURIComponent(c.slice(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
const csrftoken = getCookie('csrftoken');

function flashMessage(msg, type='info') {
  const box = document.getElementById('wl-messages');
  const el = document.createElement('div');
  el.textContent = msg;
  el.className = 'p-2 mb-2 rounded ' + (type === 'success' ? 'bg-green-100 text-green-800' : type==='error' ? 'bg-red-100 text-red-800' : 'bg-gray-100');
  box.appendChild(el);
  setTimeout(()=> el.remove(), 3500);
}

document.addEventListener('click', async function(e) {
  // ----------------- Remove from wishlist -----------------
  const removeBtn = e.target.closest('.btn-remove-wl');
  if (removeBtn) {
    const btn = removeBtn;
    const wlId = btn.dataset.wishlistId;
    const url = btn.dataset.url;
    if (!url) return;
    btn.disabled = true;

    try {
      const resp = await fetch(url, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrftoken,
          'X-Requested-With': 'XMLHttpRequest',
          'Content-Type': 'application/json'
        },
        credentials: 'same-origin',
        body: JSON.stringify({})
      });

      if (resp.status === 200) {
        const data = await resp.json();
        if (data.deleted) {
          const card = btn.closest('.wish-card');
          card?.remove();
          flashMessage('Item removed from wishlist', 'success');
        } else {
          flashMessage('Failed to remove item', 'error');
          btn.disabled = false;
        }
      } else if (resp.status === 403) {
        flashMessage('Permission denied', 'error');
        btn.disabled = false;
      } else {
        flashMessage('Server error', 'error');
        btn.disabled = false;
      }
    } catch (err) {
      console.error(err);
      flashMessage('Network error', 'error');
      btn.disabled = false;
    }
    return; // selesai handling remove
  }

  // ----------------- Add to cart -----------------
  const addBtn = e.target.closest('.btn-add-cart');
  if (addBtn) {
    const btn = addBtn;
    const productId = btn.dataset.productId;
    const url = btn.dataset.url;
    if (!productId || !url) return;
    btn.disabled = true;

    try {
      const resp = await fetch(url, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrftoken,
          'X-Requested-With': 'XMLHttpRequest',
          'Content-Type': 'application/json'
        },
        credentials: 'same-origin',
        body: JSON.stringify({ quantity: 1 })
      });

      if (resp.ok) {
        let data = {};
        try { data = await resp.json(); } catch (_) { /* not JSON */ }
        flashMessage(data.message || 'Added to cart', 'success');
        btn.disabled = false;
      } else {
        flashMessage('Failed to add to cart', 'error');
        btn.disabled = false;
      }
    } catch (err) {
      console.error(err);
      flashMessage('Network error', 'error');
      btn.disabled = false;
    }
    return; // selesai handling add
  }
});
</script>

{% endblock %}